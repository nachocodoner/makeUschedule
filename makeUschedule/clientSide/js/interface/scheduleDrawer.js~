(function(se){
	var gridDisplayWidth;
	var gridDisplayHeight;
	var dayOfWeekLiWidth;
	var timeLiHeight;
	var borderLiDayOfWeekWidth;
	var borderLiTimeWidth;
	
	var nameDaysOfWeek;
	
	se.Interface.ScheduleDrawer = new Class({
		initialize: function(){
			var langManager = new se.Managers.MultiLangManager();
			nameDaysOfWeek = [langManager._("monday"), langManager._("tuesday"), langManager._("wednesday"), langManager._("thursday"), langManager._("friday"), langManager._("saturday"), langManager._("sunday")];
		},
		loadSchedule: function(workarea, schedule){
			var data = {
				schedule: {
					id : schedule.id 
				}
			};
			
			var htmlTemplate =  tmpl("scheduleTemplate", data);
			
			workarea.display.set('html', htmlTemplate);
			
			schedule.element = $("schedule"+schedule.id);
			
			schedule.element.store('ref', schedule);
			
			this.modifyScheduleDaysOfWeek(schedule);
			this.modifyScheduleTimes(schedule);
			this.reloadGridSchedule(schedule);
			
			var objDaysOfWeek = $$("#schedule"+schedule.id+" #weekDaysTasks #daysOfWeek")[0];
			var objTimes = $$("#schedule"+schedule.id+" #hours")[0];
			
			$("schedule"+schedule.id).setStyle('width', objDaysOfWeek.getSize().x + objTimes.getSize().x);
		},
		reloadGridSchedule: function(schedule){
			var scheduleDiv = $("schedule"+schedule.id);
			var gridDisplay = scheduleDiv.getElementById('gridDisplay');
			
			var objDaysOfWeek = $$("#schedule"+schedule.id+" #weekDaysTasks #daysOfWeek")[0];
			var objTimes = $$("#schedule"+schedule.id+" #hours")[0];
			
			gridDisplayWidth = objDaysOfWeek.getSize().x;
			gridDisplayHeight = objTimes.getSize().y-objTimes.getStyle('padding-top').toInt();
			gridDisplay.set('width', gridDisplayWidth);
			gridDisplay.set('height', gridDisplayHeight);
			
			var ctx = gridDisplay.getContext('2d');
			ctx.strokeStyle = '#EEE';
			
			var timeRows = (schedule.to - schedule.since)/schedule.each;
						 
			var timeLi = objTimes.getElements('li')[0];
			borderLiTimeWidth = timeLi.getStyle('border-width').toInt();
			timeLiHeight = timeLi.getSize().y;
			
			for(var i = 0, y = timeLiHeight; i <= timeRows; i++, y+=timeLiHeight){
			 ctx.beginPath();
			 ctx.moveTo(0, y+0.5-borderLiTimeWidth);
			 ctx.lineTo(gridDisplayWidth, y+0.5-borderLiTimeWidth);
			 ctx.stroke();
			}
			
			var dayOfWeekLi = objDaysOfWeek.getElements('li')[0];
			borderLiDayOfWeekWidth = dayOfWeekLi.getStyle('border-width').toInt();
			dayOfWeekLiWidth = dayOfWeekLi.getSize().x;
			
			
			for(var i = 0, x = dayOfWeekLiWidth; i <= timeRows; i++, x+=dayOfWeekLiWidth){
			 ctx.beginPath();
			 ctx.moveTo(x+0.5-borderLiDayOfWeekWidth, 0);
			 ctx.lineTo(x+0.5-borderLiDayOfWeekWidth, gridDisplayHeight-borderLiDayOfWeekWidth);
			 ctx.stroke();
			}
		},
		modifyScheduleDaysOfWeek: function(schedule){
			schedule.nameDaysOfWeek = se.Util.booleansToDaysOfWeek(schedule.daysOfWeek, nameDaysOfWeek);
			
			var data = {
				schedule: {
					daysOfWeek : schedule.nameDaysOfWeek
				}
			};
			
			var objSchedule = $$("#schedule"+schedule.id+" #weekDaysTasks")[0];
			
			var htmlTemplate =  tmpl("scheduleDaysOfWeekTemplate", data);
			htmlTemplate = htmlTemplate + objSchedule.get('html');
			
			objSchedule.set('html', htmlTemplate);			
		},
		modifyScheduleTimes: function(schedule){
			var times = se.Util.getArrayTimes(schedule.since, schedule.to, schedule.each);
			
			var data = {
				schedule: {
					times : times
				}
			};
			
			var objSchedule = $("schedule"+schedule.id);
			
			objSchedule.get('html');
			
			var htmlTemplate =  tmpl("scheduleHoursTemplate", data);
			htmlTemplate = htmlTemplate + objSchedule.get('html');
			
			objSchedule.set('html', htmlTemplate);
		},
		addTaskTag: function(schedule, taskTag){
		
			for(var i = 0; i < taskTag.tasks.length; ++i){
				this.addTask(schedule, taskTag.tasks[i]);
				
	    	var nameSpan = new Element('span',{
	    		'html': taskTag.name
	    	});
	    	nameSpan.inject(taskTag.tasks[i].element, 'bottom');
	    	
	    	this.applyTagType(taskTag.tasks[i].element, taskTag.tagType);
	    	
	    	for(var j = 0; j < taskTag.tasks[i].additionalTags.length; ++j){
	    		this.addAdditionalTag(schedule, taskTag.tasks[i], taskTag.tasks[i].additionalTags[j]);
	    	}
			}
			
		},
		addTask: function(schedule, task){
			var taskDiv = new Element('div',{
	    		'class':	'task'
	    	});
	    	
	    	var multTopSince = (task.since - schedule.since)/schedule.each;
	    	var multTopTo = (task.to - schedule.since)/schedule.each;
	    	var multLeft = schedule.nameDaysOfWeek.indexOf(nameDaysOfWeek[task.dayOfWeek]);
	    	
	    	var topTask = multTopSince*timeLiHeight;
	    	var leftTask = dayOfWeekLiWidth*multLeft;
	    	var widthTask = dayOfWeekLiWidth-borderLiDayOfWeekWidth;
	    	var heightTask = (multTopTo*timeLiHeight)-topTask-borderLiTimeWidth;
	    	
	    	taskDiv.setStyles({
	    		top: topTask,
	    		left: leftTask,
	    		width: widthTask,
	    		height: heightTask
	    	});
	    	
	    	task.element = taskDiv;
	    	
	    	var scheduleTasksDisplay = schedule.element.getElementById('tasksDisplay');
	    	taskDiv.inject(scheduleTasksDisplay, 'bottom');
		},
		addAdditionalTag: function(schedule, task, additionalTag){
			this.applyTagType(task.element, additionalTag.tagType);
		},
		applyTagType: function(element, tagType){
			switch(tagType.type){
	    		case 0:
	    			element.setStyles({
	    				'background-color': tagType.color
	    			});
	    			break;
	    		case 1:
	    			element.getElements('span')[0].setStyles({
	    				'color': tagType.color
	    			});
	    			break;
	    		case 2:
	    			element.addClass('taskBorder');
	    			element.setStyles({
	    				'border-color': tagType.color
	    			});
	    			var borderWidth = element.getStyle('border-width').toInt();
	    			element.setStyles({
	    				width: -1*borderWidth*2+element.getStyle('width').toInt(),
	    				height: -1*borderWidth*2+element.getStyle('height').toInt()
	    			});	
	    			break;
	    	}
		},
		deleteTask: function(schedule, idTask){
	
		},
		modifyTaskName: function(task, name){
	
		},
		modifyTaskDayOfWeek: function(task, dayOfWeek){
		
		},
		modifyTaskSince: function(task, since){
		
		},
		modifyTaskTo: function(task, to){
		
		}
	});


})(se);
